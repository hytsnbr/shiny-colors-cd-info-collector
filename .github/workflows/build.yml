name: Build

on:
  # 他のワークフローから呼べるようにする
  workflow_call:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: 21
          distribution: adopt
          cache: "gradle"

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@017a9effdb900e5b5b2fddfb590a105619dca3c3 # v4.4.2

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@017a9effdb900e5b5b2fddfb590a105619dca3c3 # v4.4.2
        with:
          gradle-version: wrapper

      - name: Build with Gradle
        run: gradle build

  check-json:
    name: Check JSON Changes
    runs-on: ubuntu-latest
    outputs:
      has_json: ${{ steps.check.outputs.has_json_changes }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Check for .json changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            result:
              - 'result/*.json'

      - name: Has JSON Changes
        id: check
        if: steps.filter.outputs.json == 'true'
        run: |
          echo "✅ JSONファイルの更新がありました"
          echo "has_json_changes=true" >> $GITHUB_OUTPUT

  format-json:
    name: Format JSON
    uses: ./.github/workflows/json-formatter.yml
    if: needs.check-json.outputs.has_json == 'true'
    needs: check-json
